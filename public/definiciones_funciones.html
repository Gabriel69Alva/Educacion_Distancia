<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Interactivo de Funciones</title>
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Carga de Confetti JS -->
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.min.js"></script>

    <!-- ConfiguraciÃ³n de Tailwind para usar la fuente Open Sans/PT Sans (como en tu CSS original) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        serif: ['PT Sans', 'serif'],
                    },
                    colors: {
                        'custom-bg': '#2c3e50', // Industrial dark blue
                        'custom-surface': '#34495e',
                    }
                }
            }
        }
    </script>
    
    <!-- Enlace a las fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet" />

    <!-- MathJax v3 Setup (SOLO UNA VEZ y Correcto) -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        // ConfiguraciÃ³n para MathJax 3: Define los delimitadores inline
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>

    <style>
        /* Estilos inferidos de tus archivos CSS para la funcionalidad 3D y opciones */
        .card-container {
            width: 100%;
            height: 450px;
            perspective: 1000px; /* Para el efecto 3D */
            margin-bottom: 20px;
        }

        .card {
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            position: relative;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            border-radius: inherit;
        }

        .card-front {
            background-color: #34495e; /* surface-light */
            color: #ecf0f1;
        }

        .card-back {
            transform: rotateY(180deg);
            background-color: #34495e;
            color: white;
        }
        
        /* Colores para el reverso de la tarjeta */
        .card-back.correct {
            background-color: #27ae60; /* Success Green */
        }

        .card-back.incorrect {
            background-color: #e74c3c; /* Danger Red */
        }
        
        .answer-option {
            background-color: #2c3e50; /* Primary button background */
            color: #ecf0f1;
            padding: 15px 20px;
            margin: 10px 0;
            width: 100%;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            font-size: 1.1rem;
        }

        .answer-option:hover {
            background-color: #3a536c;
            transform: translateY(-2px);
        }

        .answer-option.selected {
            border: 3px solid #f39c12; /* Yellow border for selection */
            background-color: #3a536c;
        }

        /* Estilo para los iconos de resultado */
        .result-icon .lucide-icon {
            width: 80px;
            height: 80px;
        }
        
        /* Asegurar que el math estÃ© centrado si es display-math */
        .text-explanation p {
            line-height: 1.6;
        }

    </style>
</head>

<body class="bg-gray-800 antialiased flex justify-center py-10">

    <div id="app" class="w-full max-w-2xl flex flex-col items-center">

        <!-- Marcador y Estado del Juego -->
        <div id="game-info" class="mb-6 p-4 bg-gray-700 rounded-xl shadow-lg w-full flex justify-between items-center text-gray-200">
            <div id="attempts-display" class="flex items-center text-lg font-bold">
                Intentos Restantes: <span class="ml-2 text-xl text-yellow-300">3</span>
            </div>
            <div id="question-count" class="text-lg font-semibold">
                Pregunta <span id="current-q">1</span> de <span id="total-q">5</span>
            </div>
        </div>

        <!-- Contenedor de la Tarjeta 3D -->
        <div id="card-container" class="card-container">
            <div id="quiz-card" class="card">
                
                <!-- Frente de la Tarjeta (Pregunta y Opciones) -->
                <div id="card-front" class="card-face card-front">
                    <h2 id="question-text" class="text-2xl font-bold mb-6 text-gray-100 text-center">Cargando pregunta...</h2>
                    <div id="options-container" class="w-full">
                        <!-- Opciones de respuesta generadas por JS -->
                    </div>
                </div>

                <!-- Reverso de la Tarjeta (Resultado y ExplicaciÃ³n) -->
                <div id="card-back" class="card-face card-back text-center p-6 flex flex-col items-center justify-center">
                    <div id="result-icon-container" class="result-icon mb-4">
                        <!-- Icono (Check o X) generado por JS -->
                    </div>
                    <p id="result-message" class="text-3xl font-extrabold mb-3 text-white">Â¡Respuesta Correcta!</p>
                    <div class="text-explanation text-base text-left w-full text-gray-100">
                        <p class="font-bold mb-1">ExplicaciÃ³n:</p>
                        <p id="explanation-text">La explicaciÃ³n de la respuesta correcta se mostrarÃ¡ aquÃ­.</p>
                        <p class="mt-2 text-sm font-semibold">Respuesta Correcta: <span id="correct-answer-text" class="font-bold"></span></p>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- BotÃ³n de Siguiente Pregunta -->
        <button id="next-button" class="mt-8 px-8 py-3 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold rounded-full shadow-xl transition duration-300 hidden" onclick="nextQuestion()">
            Siguiente Pregunta <i data-lucide="chevron-right" class="inline-block w-5 h-5 ml-1"></i>
        </button>

        <!-- Mensaje de Fin del Juego (Oculto inicialmente) -->
        <div id="game-over-message" class="mt-8 p-6 bg-gray-700 rounded-xl shadow-xl w-full text-center hidden">
            <p id="final-status" class="text-3xl font-extrabold mb-3"></p>
            <p id="score-summary" class="text-xl"></p>
            <button class="mt-4 px-6 py-2 bg-yellow-400 text-gray-900 font-bold rounded-full hover:bg-yellow-300" onclick="restartGame()">
                Reiniciar Juego
            </button>
        </div>

    </div>

    <script>
        // InicializaciÃ³n de la librerÃ­a de Ã­conos Lucide
        lucide.createIcons();

        // InicializaciÃ³n del Confetti
        let jsConfetti;
        if (typeof JSConfetti !== 'undefined') {
            jsConfetti = new JSConfetti();
        }

        // -----------------------------------------------------------
        // 1. DATOS DEL QUIZ (Preguntas, Opciones, Respuestas, Explicaciones)
        // Se corrigieron los caracteres de escape (\) en las opciones con cÃ³digo matemÃ¡tico.
        // -----------------------------------------------------------

        const quizData = [
            {
                question: "Una funciÃ³n es par si:",
                options: ["A) $f(x)=f(x+c)$", "B) $f(x)=-f(-x)$", "C) $f(x)=f(-x)$", "D) $-f(x)=f(x)$"],
                correctAnswer: "C) $f(x)=f(-x)$",
                explanation: "Ser par significa que la funciÃ³n satisface la igualdad $f(x)=f(-x)$ para cualquier valor de $x$. Es decir, es simÃ©trica con respecto al eje Y."
            },
            {
                question: "Â¿QuÃ© propiedad cumplen las funciones impares?",
                options: ["A) $f(x)=f(-x)$", "B) $f(x)=-f(-x)$", "C) $-f(x)=f(x)$", "D) $f(x)=f(x+c)$"],
                correctAnswer: "B) $f(x)=-f(-x)$",
                explanation: "Ser impar significa que la funciÃ³n satisface la igualdad $f(x)=-f(-x)$ para cualquier valor de $x$. Es decir, es simÃ©trica con respecto al origen."
            },
            {
                question: "Una funciÃ³n $f(x)$ es inyectiva si:",
                options: ["A) $f(a) \\neq f(b)$ entonces $a \\neq b$", "B) $f(a)=f(b)$ entonces $a=b$", "C) $a=b$, entonces $f(a)=f(b)$", "D) $f$ es impar"],
                correctAnswer: "B) $f(a)=f(b)$ entonces $a=b$",
                explanation: "Una funciÃ³n es inyectiva si la imagen de cualquier elemento de su dominio es Ãºnica. La forma equivalente es: Si $f(a)=f(b)$, entonces $a=b$."
            },
            {
                question: "Una funciÃ³n es superyectiva si:",
                options: ["A) $f(a) \\neq f(b)$ entonces $a \\neq b$", "B) $f(a)=f(b)$ entonces $a=b$", "C) para todo $y$ en el contradominio, existe un $x$ en el dominio tal que $f(x)=y$", "D) $f$ es par"],
                correctAnswer: "C) para todo $y$ en el contradominio, existe un $x$ en el dominio tal que $f(x)=y$",
                explanation: "Una funciÃ³n suprayectiva (o sobreyectiva) no tiene elementos sueltos en el contradominio."
            },
            {
                question: "Una funciÃ³n se dice biyectiva si:",
                options: ["A) es par e impar a la vez", "B) es impar e inyectiva", "C) es creciente e impar", "D) es inyectiva y suprayectiva"],
                correctAnswer: "D) es inyectiva y suprayectiva",
                explanation: "Una funciÃ³n es biyectiva si es inyectiva y suprayectiva a la vez."
            }
        ];

        // -----------------------------------------------------------
        // 2. VARIABLES GLOBALES DE ESTADO
        // -----------------------------------------------------------

        let currentQuestionIndex = 0;
        let attemptsRemaining = 3; // Intentos incorrectos globales (vidas)
        let totalScore = 0;
        let isCardFlipped = false;
        let isGameDisabled = false;

        // -----------------------------------------------------------
        // 3. REFERENCIAS DEL DOM
        // -----------------------------------------------------------

        const card = document.getElementById('quiz-card');
        const cardBack = document.getElementById('card-back');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const nextButton = document.getElementById('next-button');
        const attemptsDisplay = document.querySelector('#attempts-display span');
        const currentQDisplay = document.getElementById('current-q');
        const totalQDisplay = document.getElementById('total-q');
        const gameOverMessage = document.getElementById('game-over-message');
        const finalStatus = document.getElementById('final-status');
        const scoreSummary = document.getElementById('score-summary');

        // Inicializar el nÃºmero total de preguntas
        totalQDisplay.textContent = quizData.length;

        // -----------------------------------------------------------
        // 4. FUNCIONES PRINCIPALES
        // -----------------------------------------------------------

        /**
         * Carga la pregunta actual en la tarjeta.
         */
        function loadQuestion() {
            // Verificar si el juego terminÃ³ por completar todas las preguntas
            if (currentQuestionIndex >= quizData.length) {
                endGame();
                return;
            }

            // Si el juego estÃ¡ deshabilitado por falta de intentos, no cargar nada.
            if (isGameDisabled) return;

            const currentQ = quizData[currentQuestionIndex];

            // 1. Resetear el estado de la tarjeta y botones
            card.classList.remove('is-flipped');
            cardBack.className = 'card-face card-back'; // Limpiar clases de color
            nextButton.classList.add('hidden');
            isCardFlipped = false;
            
            // 2. Actualizar texto de la pregunta y contador (El texto de la pregunta tambiÃ©n puede contener MathJax)
            questionText.textContent = currentQ.question;
            currentQDisplay.textContent = currentQuestionIndex + 1;

            // 3. Generar opciones de respuesta
            optionsContainer.innerHTML = '';
            currentQ.options.forEach(option => {
                const optionDiv = document.createElement('div');
                // IMPORTANTE: Usar innerHTML para que MathJax reconozca el cÃ³digo matemÃ¡tico
                optionDiv.innerHTML = option; 
                optionDiv.className = 'answer-option hover:shadow-md';
                optionDiv.onclick = () => handleAnswerClick(option, currentQ, optionDiv);
                optionsContainer.appendChild(optionDiv);
            });
            
            // 4. FIX: Pedir a MathJax que procese el contenido nuevo (pregunta y opciones)
            if (window.MathJax) {
                // typesetPromise acepta un array de elementos a procesar
                MathJax.typesetPromise([questionText, optionsContainer]).catch(err => console.error("MathJax typesetting error in loadQuestion:", err));
            }
        }

        /**
         * Maneja el clic en una opciÃ³n de respuesta.
         * @param {string} selectedOption - La opciÃ³n seleccionada por el usuario.
         * @param {Object} currentQ - El objeto de la pregunta actual.
         * @param {HTMLElement} selectedDiv - El div de la opciÃ³n seleccionada.
         */
        function handleAnswerClick(selectedOption, currentQ, selectedDiv) {
            if (isCardFlipped || isGameDisabled) return;

            Array.from(optionsContainer.children).forEach(div => {
                div.style.pointerEvents = 'none'; 
                if (div === selectedDiv) {
                    div.classList.add('selected');
                }
            });

            const isCorrect = selectedOption === currentQ.correctAnswer;

            if (!isCorrect) {
                attemptsRemaining--;
                attemptsDisplay.textContent = attemptsRemaining;
            } else {
                totalScore++; 
            }

            setTimeout(() => {
                flipCard(isCorrect, currentQ);
            }, 300); 

            if (attemptsRemaining <= 0) {
                isGameDisabled = true;
                setTimeout(endGame, 1500); 
            }
        }

        /**
         * Gira la tarjeta y muestra el resultado en el reverso.
         * @param {boolean} isCorrect - Indica si la respuesta fue correcta.
         * @param {Object} qData - Los datos de la pregunta.
         */
        function flipCard(isCorrect, qData) {
            isCardFlipped = true;
            card.classList.add('is-flipped');

            if (!isGameDisabled) {
                nextButton.classList.remove('hidden');
            }

            const resultIconContainer = document.getElementById('result-icon-container');
            const resultMessage = document.getElementById('result-message');
            const explanationText = document.getElementById('explanation-text');
            const correctAnswerText = document.getElementById('correct-answer-text');

            resultIconContainer.innerHTML = '';

            if (isCorrect) {
                cardBack.classList.add('correct');
                resultIconContainer.innerHTML = '<i data-lucide="check-circle" class="lucide-icon text-white"></i>';
                resultMessage.textContent = 'Â¡Respuesta Correcta!';
                
                // Muestra confeti por un momento
                if (jsConfetti) {
                    jsConfetti.addConfetti({ emojis: ['âœ…', 'ðŸ§ ', 'âœ¨'] });
                }
            } else {
                cardBack.classList.add('incorrect');
                resultIconContainer.innerHTML = '<i data-lucide="x-circle" class="lucide-icon text-white"></i>';
                resultMessage.textContent = 'Â¡Respuesta Incorrecta!';
            }

            lucide.createIcons();

            // IMPORTANTE: Usar innerHTML para la respuesta correcta ya que contiene math
            correctAnswerText.innerHTML = qData.correctAnswer; 
            explanationText.innerHTML = qData.explanation; // Usar innerHTML por si la explicaciÃ³n tiene math
            
            // FIX: Pedir a MathJax que procese el contenido del reverso de la tarjeta.
            if (window.MathJax) {
                MathJax.typesetPromise([cardBack]).catch(err => console.error("MathJax typesetting error in flipCard back:", err));
            }
        }

        /**
         * Avanza a la siguiente pregunta.
         */
        function nextQuestion() {
            if (isGameDisabled) return; 
            currentQuestionIndex++;
            loadQuestion();
        }

        /**
         * Finaliza el juego y muestra el resultado final.
         */
        function endGame() {
            isGameDisabled = true;
            card.style.display = 'none';
            document.getElementById('game-info').style.display = 'none';
            nextButton.style.display = 'none';
            gameOverMessage.classList.remove('hidden');

            const totalQuestions = quizData.length;

            if (attemptsRemaining > 0) {
                finalStatus.textContent = 'Â¡Juego Completado!';
                finalStatus.classList.add('text-green-400');
                finalStatus.classList.remove('text-red-400');
                scoreSummary.textContent = `PuntuaciÃ³n Final: ${totalScore} de ${totalQuestions} correctas. Â¡Felicidades!`;
                if (jsConfetti) {
                    jsConfetti.addConfetti({ confettiNumber: 300, confettiColors: ['#a78bfa', '#fde047', '#4ade80'] });
                }
            } else {
                finalStatus.textContent = 'Â¡Juego Deshabilitado!';
                finalStatus.classList.add('text-red-400');
                finalStatus.classList.remove('text-green-400');
                scoreSummary.textContent = `PuntuaciÃ³n Final: ${totalScore} de ${totalQuestions}. El juego se detuvo por exceder el lÃ­mite de 3 respuestas incorrectas.`;
            }
        }

        /**
         * Reinicia el estado del juego.
         */
        function restartGame() {
            currentQuestionIndex = 0;
            attemptsRemaining = 3;
            totalScore = 0;
            isGameDisabled = false;

            card.style.display = 'block';
            document.getElementById('game-info').style.display = 'flex';
            attemptsDisplay.textContent = attemptsRemaining;
            gameOverMessage.classList.add('hidden');

            loadQuestion();
        }

        // -----------------------------------------------------------
        // 5. INICIALIZACIÃ“N
        // -----------------------------------------------------------

        window.onload = loadQuestion;
    </script>
</body>
</html>